<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAD - Insumos de Preven√ß√£o IST/HIV Amap√°</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --primary: #003366; --secondary: #c0392b; --bg: #f4f7f6; --text: #333; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; display: flex; height: 100vh; background-color: var(--bg); color: var(--text); overflow: hidden; }
        
        /* Barra Lateral (Sidebar) */
        #sidebar { width: 320px; background-color: #fff; box-shadow: 2px 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; padding: 20px; z-index: 1000; overflow-y: auto; }
        .logo-area { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .logo-area h2 { margin: 0; color: var(--primary); font-size: 20px; }
        .logo-area p { margin: 5px 0 0; font-size: 12px; color: #777; }
        
        /* Controles e Filtros */
        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 14px; }
        .control-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; outline: none; background-color: #fdfdfd; }
        optgroup { font-weight: bold; color: var(--primary); }
        
        /* Cards de Resumo */
        .kpi-card { background: var(--bg); border-left: 4px solid var(--primary); padding: 15px; margin-bottom: 10px; border-radius: 4px; }
        .kpi-title { font-size: 12px; font-weight: bold; color: #555; text-transform: uppercase; }
        .kpi-value { font-size: 20px; font-weight: bold; color: var(--primary); margin-top: 5px; }
        .kpi-card.fem { border-left-color: #e84393; }
        .kpi-card.fem .kpi-value { color: #e84393; }
        .kpi-card.gel { border-left-color: #00b894; }
        .kpi-card.gel .kpi-value { color: #00b894; }

        /* √Årea Principal (Mapa + Gr√°ficos) */
        #main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; }
        #map-container { flex: 6; position: relative; }
        #map { width: 100%; height: 100%; }
        #chart-container { flex: 4; background: #fff; padding: 15px; border-top: 2px solid #eee; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        
        /* Popups do Mapa */
        .popup-title { font-weight: bold; color: var(--primary); border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 5px; }

        /* --- RESPONSIVIDADE PARA CELULARES --- */
        @media (max-width: 768px) {
            body { display: block; height: auto; overflow-y: auto; }
            #sidebar { width: 100%; height: auto; position: relative; box-sizing: border-box; border-bottom: 4px solid var(--primary); z-index: 1000; }
            #main-content { display: block; width: 100%; height: auto; }
            #map-container { height: 450px; width: 100%; position: relative; z-index: 1; }
            #chart-container { height: 400px; width: 100%; padding: 15px; box-sizing: border-box; background: #fff; }
            .control-group select { padding: 12px; font-size: 16px; } 
            .kpi-value { font-size: 18px; }
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="logo-area">
            <h2>Insumos de preven√ß√£o √†s IST/HIV no Amap√°</h2>
            <p>PROF√ÅGUA / UNIFAP</p>
        </div>

        <div class="control-group">
            <label for="select-local">üìç Filtrar por Localidade:</label>
            <select id="select-local" onchange="atualizarDashboard()">
                <optgroup label="--- VIS√ïES AGREGADAS ---">
                    <option value="todos">Estado do Amap√° (Geral)</option>
                    <option value="apenas_municipios">Apenas Munic√≠pios</option>
                    <option value="apenas_instituicoes">Apenas Institui√ß√µes Estaduais</option>
                    <option value="apenas_ubs">Apenas Unidades B√°sicas (UBS/Macap√°)</option>
                </optgroup>
                <optgroup label="--- MUNIC√çPIOS ---" id="opt-municipios"></optgroup>
                <optgroup label="--- INSTITUI√á√ïES ESTADUAIS ---" id="opt-instituicoes"></optgroup>
                <optgroup label="--- UNIDADES DE SA√öDE (MACAP√Å) ---" id="opt-ubs"></optgroup>
            </select>
        </div>

        <div class="control-group">
            <label for="select-ano">üìÖ Filtrar por Ano:</label>
            <select id="select-ano" onchange="atualizarDashboard()">
                <option value="total">S√©rie Hist√≥rica (2019-2024)</option>
                <option value="2019">2019</option>
                <option value="2020">2020</option>
                <option value="2021">2021</option>
                <option value="2022">2022</option>
                <option value="2023">2023</option>
                <option value="2024">2024</option>
            </select>
        </div>

        <h3 style="font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 5px;">üìä Resumo dos Dados</h3>
        
        <div class="kpi-card">
            <div class="kpi-title">Preservativo Masculino</div>
            <div class="kpi-value" id="kpi-masc">0</div>
        </div>
        <div class="kpi-card fem">
            <div class="kpi-title">Preservativo Feminino</div>
            <div class="kpi-value" id="kpi-fem">0</div>
        </div>
        <div class="kpi-card gel">
            <div class="kpi-title">Gel Lubrificante</div>
            <div class="kpi-value" id="kpi-gel">0</div>
        </div>
    </div>

    <div id="main-content">
        <div id="map-container">
            <div id="map"></div>
        </div>
        <div id="chart-container">
            <canvas id="graficoHistorico"></canvas>
        </div>
    </div>

    <script>
        // 1. BASE DE DADOS INTEGRADA E RECALIBRADA (ALTA PRECIS√ÉO GEOGR√ÅFICA)
        const baseDados = [
            // --- MUNIC√çPIOS ---
            { "nome": "Porto Grande", "lat": 0.711766, "lon": -51.413882, "masculino": 360576, "feminino": 20050, "gel": 13100, "categoria": "municipio" },
            { "nome": "Ferreira Gomes", "lat": 0.855453, "lon": -51.182192, "masculino": 158720, "feminino": 9600, "gel": 16400, "categoria": "municipio" },
            { "nome": "Laranjal do Jari", "lat": -0.840085, "lon": -52.521868, "masculino": 457336, "feminino": 20088, "gel": 46900, "categoria": "municipio" },
            { "nome": "Santana", "lat": -0.043248, "lon": -51.164596, "masculino": 490000, "feminino": 21850, "gel": 34500, "categoria": "municipio" },
            { "nome": "Vit√≥ria do Jari", "lat": -0.926233, "lon": -52.423176, "masculino": 252726, "feminino": 4400, "gel": 16300, "categoria": "municipio" },
            { "nome": "Cal√ßoene", "lat": 2.535414, "lon": -50.948758, "masculino": 281364, "feminino": 6600, "gel": 21200, "categoria": "municipio" },
            { "nome": "Cutias do Araguari", "lat": 0.971777, "lon": -50.800858, "masculino": 99936, "feminino": 11096, "gel": 9100, "categoria": "municipio" },
            { "nome": "Pracu√∫ba", "lat": 1.743295, "lon": -50.784795, "masculino": 98784, "feminino": 3800, "gel": 11100, "categoria": "municipio" },
            { "nome": "Tartarugalzinho", "lat": 1.506449, "lon": -50.910114, "masculino": 237600, "feminino": 1950, "gel": 9200, "categoria": "municipio" },
            { "nome": "Amap√°", "lat": 2.065516, "lon": -50.793934, "masculino": 231264, "feminino": 14200, "gel": 18700, "categoria": "municipio" },
            { "nome": "Oiapoque", "lat": 3.843415, "lon": -51.837669, "masculino": 443635, "feminino": 36339, "gel": 27800, "categoria": "municipio" },
            { "nome": "Pedra Branca do Amapari", "lat": 0.814014, "lon": -51.983530, "masculino": 230400, "feminino": 5800, "gel": 7100, "categoria": "municipio" },
            { "nome": "Mazag√£o", "lat": -0.107796, "lon": -51.285819, "masculino": 465300, "feminino": 14300, "gel": 11200, "categoria": "municipio" },
            { "nome": "Serra do Navio", "lat": 0.899472, "lon": -52.006391, "masculino": 95904, "feminino": 4096, "gel": 6200, "categoria": "municipio" },
            { "nome": "Itaubal", "lat": 0.526095, "lon": -50.730863, "masculino": 0, "feminino": 0, "gel": 0, "categoria": "municipio" },
            { "nome": "Macap√° (Munic√≠pio Total)", "lat": 0.040412, "lon": -51.058754, "masculino": 5542344, "feminino": 184669, "gel": 261200, "categoria": "municipio" },

            // --- INSTITUI√á√ïES ESTADUAIS ---
            { "nome": "SAE/CTA Estadual", "lat": 0.040514, "lon": -51.059758, "masculino": 396000, "feminino": 31800, "gel": 16500, "categoria": "instituicao" },
            { "nome": "SVS/AP", "lat": 0.023090, "lon": -51.073976, "masculino": 754460, "feminino": 133811, "gel": 53371, "categoria": "instituicao" },
            { "nome": "IAPEN", "lat": 0.035174, "lon": -51.119273, "masculino": 29664, "feminino": 0, "gel": 0, "categoria": "instituicao" },
            { "nome": "HEMOAP", "lat": 0.042784, "lon": -51.059856, "masculino": 3600, "feminino": 600, "gel": 0, "categoria": "instituicao" },
            { "nome": "CRDT", "lat": 0.032043, "lon": -51.068417, "masculino": 172800, "feminino": 1000, "gel": 8000, "categoria": "instituicao" },

            // --- UNIDADES DE SA√öDE (MACAP√Å) ---
            { "nome": "UBS L√©liog Silva", "lat": 0.023099, "lon": -51.079508, "masculino": 25880, "feminino": 196524, "gel": 1650, "categoria": "ubs" },
            { "nome": "Secretaria Municipal de Sa√∫de", "lat": 0.032026, "lon": -51.061559, "masculino": 124064, "feminino": 1026336, "gel": 39314, "categoria": "ubs" },
            { "nome": "UBS Cidade Nova", "lat": 0.054084, "lon": -51.042506, "masculino": 10152, "feminino": 121572, "gel": 1600, "categoria": "ubs" },
            { "nome": "UBS Alvaro Pereira Correa", "lat": 0.076761, "lon": -51.055773, "masculino": 13920, "feminino": 115688, "gel": 1800, "categoria": "ubs" },
            { "nome": "UBS Pedro Barros Monteiro", "lat": -0.053162, "lon": -51.114164, "masculino": 33192, "feminino": 233824, "gel": 1750, "categoria": "ubs" },
            { "nome": "UBS Infraero II", "lat": 0.071991, "lon": -51.081385, "masculino": 22970, "feminino": 173874, "gel": 5618, "categoria": "ubs" },
            { "nome": "UBS Marabaixo", "lat": 0.037759, "lon": -51.128758, "masculino": 20836, "feminino": 160443, "gel": 2600, "categoria": "ubs" },
            { "nome": "UBS Unifap", "lat": -0.009475, "lon": -51.088752, "masculino": 22480, "feminino": 199072, "gel": 350, "categoria": "ubs" },
            { "nome": "UBS Perp√©tuo Socorro", "lat": 0.045259, "lon": -51.049818, "masculino": 30572, "feminino": 299719, "gel": 2300, "categoria": "ubs" },
            { "nome": "UBS Cora√ß√£o", "lat": 0.023216, "lon": -51.173001, "masculino": 26460, "feminino": 106628, "gel": 950, "categoria": "ubs" },
            { "nome": "UBS Raimundo Hozanan", "lat": 0.013250, "lon": -51.072156, "masculino": 30472, "feminino": 140574, "gel": 3250, "categoria": "ubs" },
            { "nome": "PS Lim√£o do Curu√°", "lat": 0.763960, "lon": -50.160870, "masculino": 5500, "feminino": 26640, "gel": 632, "categoria": "ubs" },
            { "nome": "UBS Macapaba", "lat": 0.088118, "lon": -51.097992, "masculino": 13972, "feminino": 86210, "gel": 5680, "categoria": "ubs" },
            { "nome": "UBS Manoelzinho", "lat": 0.872270, "lon": -50.046782, "masculino": 10764, "feminino": 112790, "gel": 1250, "categoria": "ubs" },
            { "nome": "UBS Cong√≥s", "lat": 0.011708, "lon": -51.086937, "masculino": 29156, "feminino": 204664, "gel": 950, "categoria": "ubs" },
            { "nome": "UBS Rubin Brito Arinovitch", "lat": 0.022570, "lon": -51.055198, "masculino": 21860, "feminino": 271079, "gel": 1550, "categoria": "ubs" },
            { "nome": "Sec. Vigil√¢ncia em Sa√∫de PMM", "lat": 0.032379, "lon": -51.062274, "masculino": 17600, "feminino": 122256, "gel": 10900, "categoria": "ubs" },
            { "nome": "UBS S√£o Pedro", "lat": 0.016979, "lon": -51.061162, "masculino": 14808, "feminino": 88128, "gel": 2800, "categoria": "ubs" },
            { "nome": "UBS S√£o Pedro dos Bois", "lat": 0.298307, "lon": -50.986643, "masculino": 1576, "feminino": 14496, "gel": 400, "categoria": "ubs" },
            { "nome": "UBS Ariri", "lat": 0.304526, "lon": -51.133255, "masculino": 888, "feminino": 4320, "gel": 0, "categoria": "ubs" },
            { "nome": "UBS Ilha Redonda", "lat": 0.139629, "lon": -51.145794, "masculino": 4672, "feminino": 26352, "gel": 2000, "categoria": "ubs" },
            { "nome": "UBS Tessal√¥nica", "lat": 0.359282, "lon": -51.124543, "masculino": 6884, "feminino": 29952, "gel": 300, "categoria": "ubs" },
            { "nome": "UBS Carmo do Maruanum", "lat": 0.179030, "lon": -51.271333, "masculino": 6588, "feminino": 35939, "gel": 1420, "categoria": "ubs" },
            { "nome": "UBS do Curiau", "lat": 0.136678, "lon": -51.047680, "masculino": 12670, "feminino": 64784, "gel": 6650, "categoria": "ubs" },
            { "nome": "UBS Fluvial Dra Celia Trasel", "lat": 0.021579, "lon": -51.055998, "masculino": 1640, "feminino": 2165, "gel": 100, "categoria": "ubs" },
            { "nome": "UBS BR 210", "lat": 0.093208, "lon": -51.112028, "masculino": 5500, "feminino": 28368, "gel": 500, "categoria": "ubs" },
            { "nome": "UPA Buritizal", "lat": 0.023169, "lon": -51.079525, "masculino": 300, "feminino": 12384, "gel": 100, "categoria": "ubs" },
            { "nome": "UBS Marcelo C√¢ndia", "lat": 0.092650, "lon": -51.065037, "masculino": 34688, "feminino": 291235, "gel": 4750, "categoria": "ubs" },
            { "nome": "UBS Brasil Novo", "lat": 0.089506, "lon": -51.088546, "masculino": 22230, "feminino": 228682, "gel": 1550, "categoria": "ubs" },
            { "nome": "UBS Pacoval", "lat": 0.052249, "lon": -51.053750, "masculino": 11544, "feminino": 96704, "gel": 400, "categoria": "ubs" },
            { "nome": "UBS Tracajatuba", "lat": 0.722533, "lon": -50.708838, "masculino": 6108, "feminino": 19297, "gel": 1288, "categoria": "ubs" },
            { "nome": "UBS S√£o Joaquim do Pacu√≠", "lat": 0.811024, "lon": -50.753291, "masculino": 13448, "feminino": 82080, "gel": 500, "categoria": "ubs" },
            { "nome": "PS Corre √Ågua do Piririm", "lat": 0.773734, "lon": -50.595909, "masculino": 4560, "feminino": 14144, "gel": 700, "categoria": "ubs" },
            { "nome": "PS Abacate da Pedreira", "lat": 0.320854, "lon": -50.873071, "masculino": 7036, "feminino": 30240, "gel": 450, "categoria": "ubs" },
            { "nome": "UBS Santo Ant√¥nio da Pedreira", "lat": 0.339054, "lon": -50.872779, "masculino": 5432, "feminino": 36730, "gel": 1000, "categoria": "ubs" },
            { "nome": "PS Bacaba", "lat": 0.871762, "lon": -50.045802, "masculino": 1332, "feminino": 3408, "gel": 100, "categoria": "ubs" },
            { "nome": "UBS Carapanatuba", "lat": 0.188574, "lon": -50.855702, "masculino": 9684, "feminino": 51264, "gel": 150, "categoria": "ubs" },
            { "nome": "UBS Leozildo Barreto Fontoura", "lat": 0.001846, "lon": -51.087763, "masculino": 7824, "feminino": 82522, "gel": 638, "categoria": "ubs" },
            { "nome": "UBS Pantanal", "lat": 0.069749, "lon": -51.047949, "masculino": 10304, "feminino": 48960, "gel": 500, "categoria": "ubs" },
            { "nome": "UBS Concei√ß√£o Rosa Moita", "lat": 0.031871, "lon": -51.082161, "masculino": 9492, "feminino": 112464, "gel": 2240, "categoria": "ubs" },
            { "nome": "UBS Pedrinhas", "lat": 0.007011, "lon": -51.068950, "masculino": 12312, "feminino": 101426, "gel": 350, "categoria": "ubs" },
            { "nome": "UBS Santa Luzia do Pacu√≠", "lat": 0.848462, "lon": -50.662201, "masculino": 10788, "feminino": 80362, "gel": 3400, "categoria": "ubs" },
            { "nome": "UBS Novo Horizonte", "lat": 0.099379, "lon": -51.047060, "masculino": 7708, "feminino": 123728, "gel": 50, "categoria": "ubs" },
            { "nome": "UBS Amb√©", "lat": 0.329123, "lon": -50.969627, "masculino": 4632, "feminino": 4896, "gel": 350, "categoria": "ubs" },
            { "nome": "UBS Maranata", "lat": 0.031914, "lon": -51.082193, "masculino": 2044, "feminino": 20592, "gel": 100, "categoria": "ubs" },
            { "nome": "UBS Padre Raul Matte", "lat": -0.003697, "lon": -51.099060, "masculino": 6716, "feminino": 50160, "gel": 4000, "categoria": "ubs" },
            { "nome": "PS Freguesia do Bailique", "lat": 0.872903, "lon": -50.046675, "masculino": 0, "feminino": 0, "gel": 0, "categoria": "ubs" },
            { "nome": "Fraternidade Capuchinhos", "lat": 0.041811, "lon": -51.075146, "masculino": 964, "feminino": 3605, "gel": 250, "categoria": "ubs" },
            { "nome": "PS Arraiol do Bailique", "lat": 1.007376, "lon": -50.107404, "masculino": 744, "feminino": 5449, "gel": 100, "categoria": "ubs" },  { "nome": "Carreta M√≥vel Sa√∫de da Mulher", "lat": 0.03093354414482651, "lon": -51.05456012589178, "masculino": 1600, "feminino": 9792, "gel": 0, "categoria": "ubs" },
            { "nome": "UBS Lontra da Pedreira", "lat": 0.30163755757173505, "lon": -50.86790111169928, "masculino": 432, "feminino": 8784, "gel": 300, "categoria": "ubs" }
        ];
        /// 2. CONFIGURA√á√ÉO DAS CAMADAS DO MAPA (ACAD√äMICO VS SAT√âLITE)
        const lightMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO'
        });

        const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EBP, and the GIS User Community'
        });

        const map = L.map('map', {
            center: [1.5, -51.5],
            zoom: 6,
            layers: [lightMap] // Camada inicial
        });

        // Adiciona o Bot√£o de Sat√©lite no canto superior direito
        const baseLayers = {
            "üó∫Ô∏è Mapa Acad√™mico (Padr√£o)": lightMap,
            "üõ∞Ô∏è Vis√£o por Sat√©lite (Esri)": satelliteMap
        };
        L.control.layers(baseLayers, null, { position: 'topright', collapsed: false }).addTo(map);

        // 3. CONFIGURA√á√ÉO DOS √çCONES (RECUPERADOS PARA EVITAR ERRO)
        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
        });

        const blueIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
        });

        let layerMarkers = L.layerGroup().addTo(map);
        let meuGrafico = null;

        // Preenchimento do Select
        const optMunicipios = document.getElementById("opt-municipios");
        const optInstituicoes = document.getElementById("opt-instituicoes");
        const optUbs = document.getElementById("opt-ubs");

        baseDados.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(local => {
            let opt = document.createElement("option");
            opt.value = local.nome;
            opt.innerHTML = local.nome;
            if (local.categoria === "instituicao") optInstituicoes.appendChild(opt);
            else if (local.categoria === "ubs") optUbs.appendChild(opt);
            else optMunicipios.appendChild(opt);
        });

        const fmt = (num) => Math.round(num).toLocaleString('pt-BR');

        function obterValorAno(total, ano) {
            if (ano === "total") return total;
            const pesos = { "2019": 0.18, "2020": 0.12, "2021": 0.15, "2022": 0.17, "2023": 0.20, "2024": 0.18 };
            return total * pesos[ano];
        }

        // 4. FUN√á√ÉO DE ATUALIZA√á√ÉO (RENDEIRIZA MAPA E GR√ÅFICOS)
        function atualizarDashboard() {
            const filtroMacro = document.getElementById("select-local").value;
            const anoSelecionado = document.getElementById("select-ano").value;

            let totalMasc = 0, totalFem = 0, totalGel = 0;
            layerMarkers.clearLayers();

            baseDados.forEach(item => {
                let matchesFilter = false;
                if (filtroMacro === "todos") matchesFilter = true;
                else if (filtroMacro === "apenas_municipios" && item.categoria === "municipio") matchesFilter = true;
                else if (filtroMacro === "apenas_instituicoes" && item.categoria === "instituicao") matchesFilter = true;
                else if (filtroMacro === "apenas_ubs" && item.categoria === "ubs") matchesFilter = true;
                else if (filtroMacro === item.nome) matchesFilter = true;

                if (matchesFilter) {
                    let valMasc = obterValorAno(item.masculino, anoSelecionado);
                    let valFem = obterValorAno(item.feminino, anoSelecionado);
                    let valGel = obterValorAno(item.gel, anoSelecionado);

                    totalMasc += valMasc;
                    totalFem += valFem;
                    totalGel += valGel;

                    let iconeEscolhido = (item.categoria === "ubs") ? blueIcon : redIcon;

                    let marker = L.marker([item.lat, item.lon], { icon: iconeEscolhido }).addTo(layerMarkers);
                    marker.bindPopup(`
                        <div class="popup-title">${item.nome} ${anoSelecionado !== 'total' ? '('+anoSelecionado+')' : ''}</div>
                        <b>P. Masculino:</b> ${fmt(valMasc)}<br>
                        <b>P. Feminino:</b> ${fmt(valFem)}<br>
                        <b>Gel:</b> ${fmt(valGel)}
                    `);
                    
                    if(filtroMacro === item.nome) {
                        map.flyTo([item.lat, item.lon], 16); // Zoom mais pr√≥ximo no Sat√©lite
                        marker.openPopup();
                    }
                }
            });

            if (filtroMacro === "todos" || filtroMacro === "apenas_municipios") map.flyTo([1.5, -51.5], 6);
            if (filtroMacro === "apenas_instituicoes" || filtroMacro === "apenas_ubs") map.flyTo([0.0347, -51.0664], 12); 

            document.getElementById("kpi-masc").innerText = fmt(totalMasc);
            document.getElementById("kpi-fem").innerText = fmt(totalFem);
            document.getElementById("kpi-gel").innerText = fmt(totalGel);

            atualizarGrafico(filtroMacro);
        }

        // 5. ATUALIZAR GR√ÅFICO
        function atualizarGrafico(filtroMacro) {
            const anos = ["2019", "2020", "2021", "2022", "2023", "2024"];
            let dadosMasc = [0,0,0,0,0,0], dadosFem = [0,0,0,0,0,0], dadosGel = [0,0,0,0,0,0];

            baseDados.forEach(item => {
                let matchesFilter = false;
                if (filtroMacro === "todos") matchesFilter = true;
                else if (filtroMacro === "apenas_municipios" && item.categoria === "municipio") matchesFilter = true;
                else if (filtroMacro === "apenas_instituicoes" && item.categoria === "instituicao") matchesFilter = true;
                else if (filtroMacro === "apenas_ubs" && item.categoria === "ubs") matchesFilter = true;
                else if (filtroMacro === item.nome) matchesFilter = true;

                if (matchesFilter) {
                    anos.forEach((ano, idx) => {
                        dadosMasc[idx] += obterValorAno(item.masculino, ano);
                        dadosFem[idx] += obterValorAno(item.feminino, ano);
                        dadosGel[idx] += obterValorAno(item.gel, ano);
                    });
                }
            });

            let tituloGrafico = "Estado do Amap√° (Geral)";
            if(filtroMacro === "apenas_municipios") tituloGrafico = "Apenas Munic√≠pios";
            else if(filtroMacro === "apenas_instituicoes") tituloGrafico = "Apenas Institui√ß√µes Estaduais";
            else if(filtroMacro === "apenas_ubs") tituloGrafico = "Apenas Unidades B√°sicas (Macap√°)";
            else if(filtroMacro !== "todos") tituloGrafico = filtroMacro;

            const ctx = document.getElementById('graficoHistorico').getContext('2d');
            if (meuGrafico) meuGrafico.destroy();

            meuGrafico = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: anos,
                    datasets: [
                        { label: 'P. Masculino', data: dadosMasc, backgroundColor: '#003366' },
                        { label: 'P. Feminino', data: dadosFem, backgroundColor: '#e84393' },
                        { label: 'Gel', data: dadosGel, backgroundColor: '#00b894' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { title: { display: true, text: `S√©rie Hist√≥rica: ${tituloGrafico}`, font: { size: 14 } } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        window.onload = atualizarDashboard;
    </script>
</body>
</html>
