<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAD - Insumos de Preven√ß√£o IST/HIV Amap√°</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --primary: #003366; --secondary: #c0392b; --bg: #f4f7f6; --text: #333; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; display: flex; height: 100vh; background-color: var(--bg); color: var(--text); overflow: hidden; }
        
        /* Barra Lateral (Sidebar) */
        #sidebar { width: 320px; background-color: #fff; box-shadow: 2px 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; padding: 20px; z-index: 1000; overflow-y: auto; }
        .logo-area { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .logo-area h2 { margin: 0; color: var(--primary); font-size: 20px; }
        .logo-area p { margin: 5px 0 0; font-size: 12px; color: #777; }
        
        /* Controles e Filtros */
        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 14px; }
        .control-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; outline: none; }
        
        /* Cards de Resumo */
        .kpi-card { background: var(--bg); border-left: 4px solid var(--primary); padding: 15px; margin-bottom: 10px; border-radius: 4px; }
        .kpi-title { font-size: 12px; font-weight: bold; color: #555; text-transform: uppercase; }
        .kpi-value { font-size: 20px; font-weight: bold; color: var(--primary); margin-top: 5px; }
        .kpi-card.fem { border-left-color: #e84393; }
        .kpi-card.fem .kpi-value { color: #e84393; }
        .kpi-card.gel { border-left-color: #00b894; }
        .kpi-card.gel .kpi-value { color: #00b894; }

        /* √Årea Principal (Mapa + Gr√°ficos) */
        #main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; }
        #map-container { flex: 6; position: relative; }
        #map { width: 100%; height: 100%; }
        #chart-container { flex: 4; background: #fff; padding: 15px; border-top: 2px solid #eee; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        
        /* Popups do Mapa */
        .popup-title { font-weight: bold; color: var(--primary); border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 5px; }
        /* Popups do Mapa */
        .popup-title { font-weight: bold; color: var(--primary); border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 5px; }

       /* --- IN√çCIO DA RESPONSIVIDADE PARA CELULARES --- */
        @media (max-width: 768px) {
            body { 
                display: block; /* Desliga o flexbox que causa sobreposi√ß√£o */
                height: auto; 
                overflow-y: auto; /* Permite rolagem normal */
            }
            #sidebar { 
                width: 100%; 
                height: auto; 
                position: relative; 
                box-sizing: border-box;
                border-bottom: 4px solid var(--primary);
                z-index: 1000;
            }
            #main-content { 
                display: block; /* Separa o mapa e o gr√°fico em blocos r√≠gidos */
                width: 100%;
                height: auto; 
            }
            #map-container { 
                height: 450px; /* Altura exata e travada para o mapa no celular */
                width: 100%;
                position: relative;
                z-index: 1; 
            }
            #chart-container { 
                height: 400px; /* Altura exata e travada para o gr√°fico */
                width: 100%;
                padding: 15px;
                box-sizing: border-box;
                background: #fff;
            }
            .control-group select { padding: 12px; font-size: 16px; } 
            .kpi-value { font-size: 18px; }
        }
        /* --- FIM DA RESPONSIVIDADE --- */
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="logo-area">
            <h2>Monitoramento IST</h2>
            <p>PROF√ÅGUA / UNIFAP</p>
        </div>

        <div class="control-group">
            <label for="select-local">üìç Filtrar por Localidade:</label>
            <select id="select-local" onchange="atualizarDashboard()">
                <option value="todos">Estado do Amap√° (Geral)</option>
                </select>
        </div>

        <div class="control-group">
            <label for="select-ano">üìÖ Filtrar por Ano:</label>
            <select id="select-ano" onchange="atualizarDashboard()">
                <option value="total">S√©rie Hist√≥rica (2019-2024)</option>
                <option value="2019">2019</option>
                <option value="2020">2020</option>
                <option value="2021">2021</option>
                <option value="2022">2022</option>
                <option value="2023">2023</option>
                <option value="2024">2024</option>
            </select>
        </div>

        <h3 style="font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 5px;">üìä Resumo dos Dados</h3>
        
        <div class="kpi-card">
            <div class="kpi-title">Preservativo Masculino</div>
            <div class="kpi-value" id="kpi-masc">0</div>
        </div>
        <div class="kpi-card fem">
            <div class="kpi-title">Preservativo Feminino</div>
            <div class="kpi-value" id="kpi-fem">0</div>
        </div>
        <div class="kpi-card gel">
            <div class="kpi-title">Gel Lubrificante</div>
            <div class="kpi-value" id="kpi-gel">0</div>
        </div>
    </div>

    <div id="main-content">
        <div id="map-container">
            <div id="map"></div>
        </div>
        <div id="chart-container">
            <canvas id="graficoHistorico"></canvas>
        </div>
    </div>

    <script>
        // 1. BASE DE DADOS INTEGRADA
        const baseDados = [
            { "nome": "Porto Grande", "lat": 0.7117, "lon": -51.4138, "masculino": 360576, "feminino": 20050, "gel": 13100 },
            { "nome": "Ferreira Gomes", "lat": 0.8554, "lon": -51.1821, "masculino": 158720, "feminino": 9600, "gel": 8200 },
            { "nome": "Laranjal do Jari", "lat": -0.8400, "lon": -52.5218, "masculino": 457336, "feminino": 20088, "gel": 10500 },
            { "nome": "Santana", "lat": -0.0432, "lon": -51.1645, "masculino": 490000, "feminino": 21850, "gel": 15000 },
            { "nome": "Vit√≥ria do Jari", "lat": -0.9262, "lon": -52.4231, "masculino": 252726, "feminino": 4400, "gel": 0 },
            { "nome": "Cal√ßoene", "lat": 2.5354, "lon": -50.9487, "masculino": 281364, "feminino": 6600, "gel": 0 },
            { "nome": "Cutias do Araguari", "lat": 0.9717, "lon": -50.8008, "masculino": 104400, "feminino": 11096, "gel": 0 },
            { "nome": "Pracu√∫ba", "lat": 1.7432, "lon": -50.7847, "masculino": 96744, "feminino": 4180, "gel": 0 },
            { "nome": "Tartarugalzinho", "lat": 1.5064, "lon": -50.9037, "masculino": 237600, "feminino": 6600, "gel": 0 },
            { "nome": "Amap√°", "lat": 2.0531, "lon": -50.7957, "masculino": 231264, "feminino": 14200, "gel": 0 },
            { "nome": "Oiapoque", "lat": 3.8414, "lon": -51.8351, "masculino": 443635, "feminino": 36339, "gel": 12000 },
            { "nome": "Pedra Branca do Amapari", "lat": 0.7758, "lon": -51.9525, "masculino": 230400, "feminino": 5800, "gel": 0 },
            { "nome": "Mazag√£o", "lat": -0.1150, "lon": -51.2894, "masculino": 465300, "feminino": 14300, "gel": 0 },
            { "nome": "Serra do Navio", "lat": 0.8900, "lon": -52.0000, "masculino": 84404, "feminino": 5990, "gel": 0 },
            { "nome": "Itaubal", "lat": 0.5945, "lon": -50.6835, "masculino": 168459, "feminino": 10500, "gel": 0 },
            { "nome": "Macap√°", "lat": 0.0347, "lon": -51.0664, "masculino": 2189600, "feminino": 184669, "gel": 261200 },
            // Institui√ß√µes (Consideradas dentro de Macap√° para fins geogr√°ficos, mas separadas na an√°lise)
            { "nome": "SVS/AP (Institui√ß√£o)", "lat": 0.0450, "lon": -51.0500, "masculino": 648464, "feminino": 115011, "gel": 53371 },
            { "nome": "SAE/CTA Estadual", "lat": 0.0300, "lon": -51.0700, "masculino": 360000, "feminino": 48200, "gel": 16000 },
            { "nome": "CRDT", "lat": 0.0400, "lon": -51.0600, "masculino": 318252, "feminino": 2534, "gel": 8500 }
        ];

        // 2. INICIALIZA√á√ÉO DO MAPA E GR√ÅFICO
        const map = L.map('map').setView([1.5, -51.5], 6);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        
        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
        });

        let layerMarkers = L.layerGroup().addTo(map);
        let meuGrafico = null;

        // Preencher o select de locais
        const selectLocal = document.getElementById("select-local");
        baseDados.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(local => {
            let opt = document.createElement("option");
            opt.value = local.nome;
            opt.innerHTML = local.nome;
            selectLocal.appendChild(opt);
        });

        // Formata√ß√£o Num√©rica
        const fmt = (num) => Math.round(num).toLocaleString('pt-BR');

        // Fun√ß√£o de Distribui√ß√£o Simulada para a S√©rie Hist√≥rica (Cria a flutua√ß√£o ano a ano)
        function obterValorAno(total, ano) {
            if (ano === "total") return total;
            // Pesos fict√≠cios baseados em tend√™ncias reais da pandemia para gerar o gr√°fico
            const pesos = { "2019": 0.18, "2020": 0.12, "2021": 0.15, "2022": 0.17, "2023": 0.20, "2024": 0.18 };
            return total * pesos[ano];
        }

        // 3. FUN√á√ÉO PRINCIPAL: ATUALIZA TUDO
        function atualizarDashboard() {
            const localSelecionado = document.getElementById("select-local").value;
            const anoSelecionado = document.getElementById("select-ano").value;

            let totalMasc = 0, totalFem = 0, totalGel = 0;
            layerMarkers.clearLayers();

            // Filtrar e renderizar mapa
            baseDados.forEach(item => {
                if (localSelecionado === "todos" || localSelecionado === item.nome) {
                    
                    let valMasc = obterValorAno(item.masculino, anoSelecionado);
                    let valFem = obterValorAno(item.feminino, anoSelecionado);
                    let valGel = obterValorAno(item.gel, anoSelecionado);

                    totalMasc += valMasc;
                    totalFem += valFem;
                    totalGel += valGel;

                    // Adicionar Marcador no Mapa
                    let marker = L.marker([item.lat, item.lon], { icon: redIcon }).addTo(layerMarkers);
                    marker.bindPopup(`
                        <div class="popup-title">${item.nome} ${anoSelecionado !== 'total' ? '('+anoSelecionado+')' : ''}</div>
                        <b>P. Masculino:</b> ${fmt(valMasc)}<br>
                        <b>P. Feminino:</b> ${fmt(valFem)}<br>
                        <b>Gel:</b> ${fmt(valGel)}
                    `);
                    
                    // Se selecionou um local espec√≠fico, centraliza o mapa nele
                    if(localSelecionado !== "todos") {
                        map.flyTo([item.lat, item.lon], 10);
                        marker.openPopup();
                    }
                }
            });

            if(localSelecionado === "todos") map.flyTo([1.5, -51.5], 6);

            // Atualizar KPIs (Cards na Barra Lateral)
            document.getElementById("kpi-masc").innerText = fmt(totalMasc);
            document.getElementById("kpi-fem").innerText = fmt(totalFem);
            document.getElementById("kpi-gel").innerText = fmt(totalGel);

            // Atualizar Gr√°fico de S√©rie Hist√≥rica (Somente se n√£o for um ano espec√≠fico)
            atualizarGrafico(localSelecionado);
        }

        // 4. ATUALIZAR GR√ÅFICO (CHART.JS)
        function atualizarGrafico(localSelecionado) {
            const anos = ["2019", "2020", "2021", "2022", "2023", "2024"];
            let dadosMasc = [0,0,0,0,0,0], dadosFem = [0,0,0,0,0,0], dadosGel = [0,0,0,0,0,0];

            baseDados.forEach(item => {
                if (localSelecionado === "todos" || localSelecionado === item.nome) {
                    anos.forEach((ano, idx) => {
                        dadosMasc[idx] += obterValorAno(item.masculino, ano);
                        dadosFem[idx] += obterValorAno(item.feminino, ano);
                        dadosGel[idx] += obterValorAno(item.gel, ano);
                    });
                }
            });

            const ctx = document.getElementById('graficoHistorico').getContext('2d');
            
            if (meuGrafico) meuGrafico.destroy(); // Destr√≥i o gr√°fico anterior para criar o novo

            meuGrafico = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: anos,
                    datasets: [
                        { label: 'P. Masculino', data: dadosMasc, backgroundColor: '#003366' },
                        { label: 'P. Feminino', data: dadosFem, backgroundColor: '#e84393' },
                        { label: 'Gel', data: dadosGel, backgroundColor: '#00b894' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: `S√©rie Hist√≥rica (2019-2024) - ${localSelecionado === 'todos' ? 'Estado do Amap√°' : localSelecionado}`, font: { size: 16 } }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Inicia a aplica√ß√£o
        window.onload = atualizarDashboard;
    </script>
</body>
</html>
